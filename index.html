<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AI City Walk (GitHub Pages)</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        #ui { position: absolute; bottom: 20px; left: 20px; color: white; pointer-events: none; z-index: 10; }
        #controls { pointer-events: auto; display: flex; gap: 10px; margin-bottom: 10px; }
        input { padding: 10px; border-radius: 20px; border: none; width: 250px; outline: none; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 20px; border: none; font-weight: bold; background: white; transition: 0.2s; }
        button:hover { background: #ddd; }
        button.primary { background: #4CAF50; color: white; }
        #status { background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; max-width: 400px; line-height: 1.5; backdrop-filter: blur(5px); }
        .loading { color: #aaa; font-size: 0.9em; }
    </style>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "https://unpkg.com/@mkkellogg/gaussian-splats-3d@0.3.0/build/gaussian-splats-3d.module.js",
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
</head>
<body>
    <div id="ui">
        <div id="controls">
            <input type="text" id="q" placeholder="ä¾‹: ãƒ¬ãƒˆãƒ­ãªå»ºç‰©, é™ã‹ãªå ´æ‰€...">
            <button id="btn-search">ğŸ” æ¤œç´¢ç§»å‹•</button>
            <button id="btn-snap" class="primary">ğŸ‘ï¸ è§£èª¬ãƒ»è¨˜éŒ²</button>
        </div>
        <div id="status">è¡—ã‚’æ­©ã„ã¦ã€Œè§£èª¬ãƒ»è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>ã‚ãªãŸã®ä½“é¨“ãŒåœ°å›³ã«ãªã‚Šã¾ã™ã€‚</div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import * as THREE from 'three';
        import { Viewer } from '@mkkellogg/gaussian-splats-3d';

        // ==========================================
        // â˜… ã“ã“ã«APIã‚­ãƒ¼ã‚’å…¥ã‚Œã‚‹
        // (å¿…ãšGoogle Cloudã§ãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶é™ã‚’ã‹ã‘ã‚‹ã“ã¨ï¼)
        const API_KEY = "YOUR_GEMINI_API_KEY"; 
        // ==========================================

        // Geminiã®æº–å‚™
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // 3Dãƒ“ãƒ¥ãƒ¼ã‚¢ã®æº–å‚™
        const viewer = new Viewer({ 'cameraUp': [0, 1, 0], 'initialCameraPosition': [0, 2, 5] });
        
        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (GitHubä¸Šã® city.ply ã‚’èª­ã‚€)
        // ãªã‘ã‚Œã°ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        viewer.addSplatScene('city.ply', { 'splatAlphaRemovalThreshold': 5 })
            .catch(() => {
                console.log("Local PLY not found, using demo.");
                viewer.addSplatScene('https://raw.githubusercontent.com/mkkellogg/gaussian-splats-3d/main/assets/data/garden/garden.ply');
            });
        viewer.start();

        // è¨˜æ†¶ç”¨é…åˆ—
        let memories = [];
        const statusDiv = document.getElementById('status');

        // --- æ©Ÿèƒ½1: æ™¯è‰²ã‚’è¦‹ã¦è¨˜éŒ²ã™ã‚‹ (Vision) ---
        document.getElementById('btn-snap').addEventListener('click', async () => {
            statusDiv.innerHTML = "<span class='loading'>AIãŒæ™¯è‰²ã‚’è§£æä¸­...</span>";
            
            try {
                // 1. ç”»é¢ã‚’ç”»åƒ(Base64)ã«å¤‰æ›
                const canvas = document.querySelector('canvas');
                // ç”»è³ªã‚’å°‘ã—è½ã¨ã—ã¦è»½é‡åŒ–
                const imageBase64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                
                // ã‚«ãƒ¡ãƒ©æƒ…å ±ã®ä¿å­˜
                const currentLoc = {
                    pos: viewer.camera.position.clone(),
                    rot: viewer.camera.rotation.clone()
                };

                // 2. Gemini Vision API ã«é€ä¿¡
                const prompt = "ã“ã®é¢¨æ™¯ã«è¦‹ãˆã‚‹ã‚‚ã®ã‚’ã€æ§‹é€ ç‰©ã‚„é›°å›²æ°—ã‚’å«ã‚ã¦30æ–‡å­—ç¨‹åº¦ã®æ—¥æœ¬èªã§æƒ…ç·’çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚";
                const result = await model.generateContent([
                    prompt,
                    { inlineData: { data: imageBase64, mimeType: "image/jpeg" } }
                ]);
                const text = result.response.text();

                // 3. ãƒ¡ãƒ¢ãƒªã«è¿½åŠ 
                memories.push({ id: memories.length, text: text, loc: currentLoc });
                
                statusDiv.innerHTML = `<strong>è¨˜éŒ²ã—ã¾ã—ãŸ:</strong><br>${text}`;

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ã®è¨­å®šã‹ã€é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
            }
        });

        // --- æ©Ÿèƒ½2: è¨€è‘‰ã§å ´æ‰€ã‚’æ¢ã™ (Reasoning) ---
        document.getElementById('btn-search').addEventListener('click', async () => {
            const query = document.getElementById('q').value;
            if (!query) return;
            if (memories.length === 0) {
                statusDiv.innerText = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯æ­©ã„ã¦è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚";
                return;
            }

            statusDiv.innerHTML = "<span class='loading'>AIãŒè¨˜æ†¶ã‚’æ¢ç´¢ä¸­...</span>";

            try {
                // 4. å…¨ãƒ­ã‚°ã‚’Geminiã«æ¸¡ã—ã¦é¸ã°ã›ã‚‹
                // (ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªã®ã§ã€æ¯å›ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦é€ã‚‹)
                const memoryList = memories.map(m => `ID:${m.id} å†…å®¹:${m.text}`).join("\n");
                
                const searchPrompt = `
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œ${query}ã€ã¨ã„ã†å ´æ‰€ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚
                ä»¥ä¸‹ã®è¨˜éŒ²ãƒªã‚¹ãƒˆã‹ã‚‰ã€æœ€ã‚‚åˆè‡´ã™ã‚‹å ´æ‰€ã®IDã‚’1ã¤ã ã‘æ•°å­—ã§é¸ã‚“ã§ãã ã•ã„ã€‚
                åˆè‡´ã™ã‚‹ã‚‚ã®ãŒãªã‘ã‚Œã° -1 ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

                [è¨˜éŒ²ãƒªã‚¹ãƒˆ]
                ${memoryList}
                `;

                const result = await model.generateContent(searchPrompt);
                const answer = parseInt(result.response.text().trim());

                if (!isNaN(answer) && answer !== -1) {
                    const target = memories.find(m => m.id === answer);
                    statusDiv.innerHTML = `<strong>ç™ºè¦‹ï¼</strong><br>${target.text}`;
                    
                    // ç§»å‹•
                    viewer.camera.position.copy(target.loc.pos);
                    viewer.camera.rotation.copy(target.loc.rot);
                } else {
                    statusDiv.innerText = "ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«åˆã†å ´æ‰€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            }
        });
    </script>
</body>
</html>
